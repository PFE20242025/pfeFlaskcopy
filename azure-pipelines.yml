trigger:
- main

resources:
- repo: self

variables:
- group: docker-credentials  # Ce groupe doit contenir DOCKER_USERNAME et DOCKER_PASSWORD

- name: imageName
  value: 'my-flask-app'

- name: tag
  value: 'latest'

stages:
- stage: BuildAndPush
  displayName: Build and Push to Docker Hub
  jobs:
  - job: Build
    displayName: Build and Push Image
    pool:
      vmImage: ubuntu-latest
    steps:
    - script: |
        echo "$(DOCKER_PASSWORD)" | docker login -u "$(DOCKER_USERNAME)" --password-stdin
      displayName: Docker Hub login

    - task: Docker@2
      displayName: Build Docker image
      inputs:
        command: build
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        repository: $(DOCKER_USERNAME)/$(imageName)
        tags: |
          $(tag)

    - task: Docker@2
      displayName: Push Docker image to Docker Hub
      inputs:
        command: push
        repository: $(DOCKER_USERNAME)/$(imageName)
        tags: |
          $(tag)

